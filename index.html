<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
<!--        <meta name="viewport" content="width=device-width, initial-scale=1" />-->
        <link rel="stylesheet" href="https://cdn.rawgit.com/mistic100/Photo-Sphere-Viewer/master/dist/photo-sphere-viewer.min.css" />
        <link rel="stylesheet" href="css/stylesheet.css" />
        <script src="https://cdn.rawgit.com/mrdoob/three.js/master/build/three.js"></script>
<!--        <script src="https://cdn.rawgit.com/mistic100/Photo-Sphere-Viewer/master/dist/photo-sphere-viewer.js"></script>-->
        <script src="js/photo-sphere-viewer.min.js"></script>
        
        <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script src="http://code.jquery.com/jquery-2.2.1.min.js"></script>
<!--
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous" />
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <link href="cover.css" rel="stylesheet" />
-->
        
<!--
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.0/angular.min.js"></script>
        <script src="app.js"></script>
-->
    </head>
    <body>
        <div id="container"></div>
        
        <div id="caption-content" class="preparing-content">
            <div onclick="javascript:viewer.gotoMarker('airTemp', 500);">
                <img src="image/celsius.png" />
            </div>
            <div onclick="javascript:viewer.gotoMarker('visibleLight', 500);">
                <img src="http://52.79.130.102:8888/image/weather.png" />
            </div>
            <div onclick="javascript:viewer.gotoMarker('DO', 500);">
                <img src='image/oxygen.png'>
            </div>
        </div>
        
        <div id="marker-content" class="preparing-content">
            <div class="airTemp">
                <div class="outerCircle airTemp">
                    <div class="thermo">
                        <img src="image/thermometer.png"/>
                    </div>
                </div>
                <div class="informValue">
                    <span class="currentValue">25°C</span><br><span class="currentStatus"></span>
                </div>
            </div>
            <div class="visibleLight">
                <div class="outerCircle visibleLight">
                    <div class="circularMask">
<!--                        <img src="image/sun.png" />-->
                    </div>
                </div>
                <div class="informValue">
                    <span class="currentValue"></span><br><span class="currentStatus"></span>
                </div>
            </div>
            <div class="DO">
                <div class="outerCircle DO">
                    <div class="oxygen">
                        <p>O<sub>2</sub></p>
                    </div>
                </div>
                <div class="informValue">
                    <span class="currentValue"></span><br><span class="currentStatus"></span>
                </div>
            </div>
        </div>
        
<!--
        <div id="marker-content" class="preparing-content">
            <div class="airTemp">
                AvgAirTemp
            </div>
            <div class="visibleLight">
                AvgVisibleLight
            </div>
            <div class="DO">
                AvgDO
            </div>
        </div>
-->
        
        <div id="panel-content" class="preparing-content">
            <div class="airTemp">
                <div class="inline">
                    <div>
                        <span>
                            <img src="image/leaf_airTemp_high.png" />
                            &nbsp;덥네요.<br>&nbsp;&nbsp;&nbsp;&nbsp;지하수를 순환시켜<br>&nbsp;&nbsp;&nbsp;&nbsp;온도를 낮춥니다.
                        </span>
                    </div>
                </div>
                <div class="inline">
                    <div>
                        <span>
                            <img src="image/leaf_airTemp_med_high.png" />
                            &nbsp;조금 덥네요.<br>&nbsp;&nbsp;&nbsp;&nbsp;온실 창문을 열고<br>&nbsp;&nbsp;&nbsp;&nbsp;환기팬을 작동시킵니다.
                        </span>
                    </div>
                </div>
                <div class="inline">
                    <div>
                        <span>
                            <img src="image/leaf_airTemp_medium.png" />
                            &nbsp;매우 좋아요.<br>&nbsp;&nbsp;&nbsp;&nbsp;현재 상태를 잘 유지합니다.
                        </span>
                    </div>
                </div>
                <div class="inline">
                    <div>
                        <span>
                            <img src="image/leaf_airTemp_med_low.png" />
                            &nbsp;조금 춥네요.<br>&nbsp;&nbsp;&nbsp;&nbsp;식물용 형광등으로<br>&nbsp;&nbsp;&nbsp;&nbsp;공기를 데워야겠어요.
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="visibleLight">
                <div class="inline">
                    <div>
                        <span>
                            <img src="image/leaf_visibleLight_high.png">
                            &nbsp;빛이 강렬하네요.<br>&nbsp;&nbsp;&nbsp;&nbsp;차광막을 치고<br>&nbsp;&nbsp;&nbsp;&nbsp;적절한 광량을 유지합니다.
                        </span>
                    </div>
                </div>
                <div class="inline">
                    <div>
                        <span>
                            <img src="image/leaf_visibleLight_medium.png">
                            &nbsp;좋아요.<br>&nbsp;&nbsp;&nbsp;&nbsp;햇빛을 잘 받아 무럭무럭 자라고 있습니다.
                        </span>
                    </div>
                </div>
                <div class="inline">
                    <div>
                        <span>
                            <img src="image/leaf_visibleLight_low.png">
                            &nbsp;식물에게는 밤이에요.<br>&nbsp;&nbsp;&nbsp;&nbsp;잠을 자며 쉬는 중입니다.
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="DO">
                <div class="inline">
                    <div>
                        <span>
                            <img src="image/leaf_DO_good.png">
                            &nbsp;산소가 풍부해요.<br>&nbsp;&nbsp;&nbsp;&nbsp;물고기가 숨쉬기에도<br>&nbsp;&nbsp;&nbsp;&nbsp;식물 생장에도 매우 좋습니다.
                        </span>
                    </div>
                </div>
                <div class="inline">
                    <div>
                        <span>
                            <img src="image/leaf_DO_bad.png">
                            &nbsp;산소가 부족해요.<br>&nbsp;&nbsp;&nbsp;&nbsp;지하수를 순환시켜,<br>&nbsp;&nbsp;&nbsp;&nbsp;물 온도를 낮추고<br>&nbsp;&nbsp;&nbsp;&nbsp;산소 포화도를 높여야겠어요.
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
<!--        <div ng-repeat="caption in contents.captions">{{caption.html}}</div>-->
        
        <script class="Photo-Sphere-Viewer">
            var viewer;
            $.ajax({
                url: "http://52.79.130.102:8888/lastData.json",
                dataType: "jsonp",
                jsonpCallback: "parseData",
                success: function(data) {
                    var status = {
                        airTemp: {
                            high: '더워요',
                            med_high: '조금 더워요',
                            medium: '쾌적해요',
                            med_low: '조금 추워요',
                            low: '추워요'
                        },
                        visibleLight: {
                            high: '너무 밝아요',
                            medium: '쾌적해요',
                            low: '식물이 자고 있어요'
                        },
                        DO: {
                            good: '물이 깨끗해요',
                            bad: '새 물을 채울 거에요'
                        }
                    };
                    
                    var currentValue = ".informValue .currentValue";
                    var currentStatus = ".informValue .currentStatus";
                    
                    document.querySelector(".airTemp " + currentValue).innerHTML = data.airTemp + "°C";
                    if (Number(data.airTemp < 14.1)) {
                        document.querySelector(".airTemp " + currentStatus).innerHTML = status.airTemp.med_low;
                        document.querySelector(".airTemp .outerCircle").classList.add("low");
                    } else if (Number(data.airTemp < 30)) {
                        document.querySelector(".airTemp " + currentStatus).innerHTML = status.airTemp.medium;
                        document.querySelector(".airTemp .outerCircle").classList.add("medium");
                    } else if (Number(data.airTemp) < 33) {
                        document.querySelector(".airTemp " + currentStatus).innerHTML = status.airTemp.med_high;
                        document.querySelector(".airTemp .outerCircle").classList.add("med_high");
                    } else {
                        document.querySelector(".airTemp " + currentStatus).innerHTML = status.airTemp.high;
                        document.querySelector(".airTemp .outerCircle").classList.add("high");
                    }
                    
                    document.querySelector(".visibleLight " + currentValue).innerHTML = data.visibleLight;
                    if (Number(data.visibleLight.match(/[\d]+/g)) < 50) {
                        document.querySelector(".visibleLight " + currentStatus).innerHTML = status.visibleLight.low;
                        document.querySelector(".visibleLight .outerCircle").classList.add("low");
                        document.querySelector(".visibleLight .circularMask").classList.add("low");
                    } else if (Number(data.visibleLight.match(/[\d]+/g)) < 450) {
                        document.querySelector(".visibleLight " + currentStatus).innerHTML = status.visibleLight.medium;
                        document.querySelector(".visibleLight .outerCircle").classList.add("medium");
                        document.querySelector(".visibleLight .circularMask").classList.add("medium");
                    } else {
                        document.querySelector(".visibleLight " + currentStatus).innerHTML = status.visibleLight.high;
                        document.querySelector("visibleLight .outerCircle").classList.add("high");
                        document.querySelector(".visibleLight .circularMask").classList.add("high");
                    }
                    
                    document.querySelector(".DO " + currentValue).innerHTML = data.DO + "ppm";
                    if (Number(data.DO) < 2) {
                        document.querySelector(".DO " + currentStatus).innerHTML = status.DO.bad;
                        document.querySelector(".DO .outerCircle").classList.add("bad");
                    } else {
                        document.querySelector(".DO " + currentStatus).innerHTML = status.DO.good;
                        document.querySelector(".DO .outerCircle").classList.add("good");
                    }
                    
                    
                    var graph = {
                        airTemp: 'http://52.79.130.102:8888/airTemp.png',
                        visibleLight: 'http://52.79.130.102:8888/visibleLight.png',
                        DO: 'http://52.79.130.102:8888/DO.png'
                    };

                    var markerContent = document.querySelector("div#marker-content");
                    
                    var farmPath = 'image/farm/';
                    var today = new Date();
                    var today_hours = today.getHours();
                    if(today_hours >= 18 || today_hours < 6) {
                        farmPath += 'farm_dark_01.jpeg';
                    } else {
                        farmPath += 'farm_bright_04.jpeg';
                    }

                    var container = document.querySelector("div#container");
                    console.log(farmPath);
                    viewer = PhotoSphereViewer({
                        container: container,//required
                        panorama: farmPath,//required
                        markers: [{
                            id: 'airTemp',
        //                    html: markerContent.querySelector(".airTemp").innerHTML,
                            html: markerContent.querySelector(".airTemp").innerHTML,
        //                    width: 180,
        //                    height: 180,
                            latitude: 0,
                            longitude: Math.PI / 2,
                            content: '<div class="panel"><span class="infoTitle">농장 기온</span><div class="graph airTemp"><img src="' + graph.airTemp + '" class="graph" /></div>' + document.querySelector("#panel-content .airTemp").innerHTML + '</div>',
                            tooltip: '만나 농장은 식물에게 쾌적한 온도를 어떻게 유지할까요?'
                        }, {
                            id: 'visibleLight',//required
                            image: null,
                            html: markerContent.querySelector(".visibleLight").innerHTML, //image or html is required
                            width: null,//required for image markers, recommended for html markers
                            height: null,//required for image markers, recommended for html markers
        //                    x: null,
        //                    y: null,//With setting x/y as null, app doesn't read lat/long 
                            latitude: 0,
                            longitude: Math.PI, // x/y or latitude/longitude are required, no default value
                            className: null,
                            anchor: 'center center',//any CSS position is vaild,
                            visible: true,
                            /*tooltip: {
                                content: null,
                                position: 'top center'
                            }, //tooltip is set to be a string or an object*/
                            content: '<div class="panel"><span class="infoTitle">햇빛의 밝기</span><div class="graph visibleLight"><img src="' + graph.visibleLight + '" class="graph" /></div>' + document.querySelector("#panel-content .visibleLight").innerHTML + '</div>',
                            tooltip: '자연이 선물하는 햇빛을 받아 채소들이 자라납니다.'
                        }, {
                            id: 'DO',
                            html: markerContent.querySelector(".DO").innerHTML,
        //                    width: 320,
        //                    height: 180,
                            latitude: 0,
                            longitude: Math.PI * 3 / 2,
                            content: '<div class="panel"><span class="infoTitle">물에 녹아있는 산소</span><div class="graph DO"><img src="' + graph.DO + '" class="graph"/></div>' + document.querySelector("#panel-content .DO").innerHTML + '</div>',
                            tooltip: '식물에게 양분을 나눠주는 물고기들이 사는 물은 얼마나 깨끗할까요?'
                        }],
                        autoload: true,
                        min_fov: 30,
                        max_fov: 90,
                        default_fov: null,//viewer.max_fov
                        default_long: 0,
                        default_lat: 0,
                        tilt_up_max: Math.PI/2,
                        tilt_down_max: -Math.PI/2,
                        time_anim: 500,
                        anim_speed: '2rpm',
                        anim_lat: null,//viewer.default_lat
                        caption: document.querySelector("#caption-content").innerHTML,
                        navbar: {
                            autorotate: true,
                            zoom: true,
                            fullscreen: true,
                            download: false,
                            markers: false
                        } || true,
                        lang: {
                            autorotate: 'Automatic rotation',
                            zoom: 'Zoom',
                            zoomOut: 'Zoom out',
                            zoomIn: 'Zoom in',
                            download: 'Download',
                            fullscreen: 'Fullscreen',
                            markers: 'Markers'
                        },
                        loading_img: 'contact_info_crop.png',
                        loading_txt: null,
                        size: null,
                        mousewheel: true,
                        mousemove: true,
                        long_offset: Math.PI / 1440,
                        lat_offset: Math.PI / 720,
                        usexmpdata: true
                    });

                    var visibleMarkers,
                        scale = 1,
                        visibleMarkers,
                        IDAttr = [],
                        markerID = new String(),
                        degY = [],
                        degX = [],
                        initDegY = [],
                        initDegX = [],
                        markersCount = new Number();

                    viewer.on('ready', function() {                
                        visibleMarkers = document.querySelectorAll("div.psv-marker");
                        markersCount = visibleMarkers.length;

                        for (i = 0; i < markersCount; i++) {
                            IDAttr = visibleMarkers[i].getAttribute("id").split("-");
                            markerID = IDAttr[IDAttr.length - 1];

                            visibleMarkers[i].classList.add("visible");
                            
//                            if(!visibleMarkers[i].style.transform.match("translate3d")) {
//                                visibleMarkers[i].classList.add("tempHide");
//                            }

                            initDegY[i] = (-viewer.getMarker(markerID).longitude) * 180 / Math.PI;
                            initDegX[i] = (-viewer.getMarker(markerID).latitude) * 180 / Math.PI;

//                            visibleMarkers[i].style.transform += 'rotateY(' + initDegY[i] + 'deg) rotateX(' + initDegX[i] + 'deg) scale(1)';

                            switch(visibleMarkers[i].style.transform.search(/rotate/g)) {
                                case -1:
                                    visibleMarkers[i].style.transform += 'rotateY(' + initDegY + 'deg) rotateX(' + initDegX + 'deg)';
                                    break;
                                default:
                                    visibleMarkers[i].style.transform.replace(/rotateY\([\d.]+deg\)/g, 'rotateY(' + initDegY + 'deg)');
                                    visibleMarkers[i].style.transform.replace(/rotateX\([\d.]+deg\)/g, 'rotateX(' + initDegX + 'deg)');
                                    break;
                            }
                        }
                    });

                    viewer.on('zoom-updated', function(level) {
                        scale = 1 + level / 50;
        //                visibleMarkers = document.querySelectorAll("div.psv-marker");

                        var lastDegY = degY.length > 0 ? degY : initDegY,
                            lastDegX = degX.length > 0 ? degX : initDegX;

                        for (i = 0; i < markersCount; i++) {
                            transformValue = visibleMarkers[i].style.transform;

                            switch(visibleMarkers[i].style.transform.search(/scale/g)) {
                                case -1:
                                    visibleMarkers[i].style.transform += 'scale(' + scale + ')';
                                    break;
                                default:
                                    visibleMarkers[i].style.transform.replace(/scale\(([\d.]+)\)/g, scale);
                                    break;
                            }

                            switch(visibleMarkers[i].style.transform.search(/rotate/g)) {
                                case -1:
                                    visibleMarkers[i].style.transform += ' rotateY(' + lastDegY[i] + 'deg) rotateX(' + lastDegX[i] + 'deg)';
                                    break;
                                default:
                                    visibleMarkers[i].style.transform.replace(/rotateY\(([\d.]+)deg\) rotateX\(([\d.]+)deg\)/g, lastDegY[i] + ', ' + lastDegX[i]);
                                    break;
                            }
                        }
                    });
                    
//                    viewer.on('click', function(data) {
//                        console.log(data);
//                    });
//                    
//                    viewer.on('select-marker', function(marker) {
//                        console.log(marker.id);
//                    });
//                    
//                    viewer.on('unselect-marker', function() {
//                        console.log('A marker is unselected.');
//                    });

                    viewer.on('position-updated', function(long, lat) {
        //                visibleMarkers = document.querySelectorAll("div.psv-marker");

                        for (i = 0; i < markersCount; i++) {
                            IDAttr = visibleMarkers[i].getAttribute("id").split("-");
                            markerID = IDAttr[IDAttr.length - 1];
                            degY[i] = (-viewer.getMarker(markerID).longitude + long) * 180 / Math.PI;
                            degX[i] = (-viewer.getMarker(markerID).latitude + lat) * 180 / Math.PI;
                            
//                            if(visibleMarkers[i].style.transform.match("translate3d")) {
//                                visibleMarkers[i].classList.remove("tempHide");
//                            }

                            switch(visibleMarkers[i].style.transform.search(/scale/g)) {
                                case -1:
                                    visibleMarkers[i].style.transform += 'scale(' + scale + ')';
                                    break;
                                default:
                                    visibleMarkers[i].style.transform.replace(/scale\(([\d.]+)\)/g, scale);
                                    break;
                            }

                            switch(visibleMarkers[i].style.transform.search(/rotate/g)) {
                                case -1:
                                    visibleMarkers[i].style.transform += ' rotateY(' + degY[i] + 'deg) rotateX(' + degX[i] + 'deg)';
                                    break;
                                default:
                                    visibleMarkers[i].style.transform.replace(/rotateY\(([\d.]+)deg\) rotateX\(([\d.]+)deg\)/g, degY[i] + ', ' + degX[i]);
                                    break;
                            }
                        }  
                    });
                    
                    viewer.on('size-updated', function(width, height) {
                        if (degX.length) {
                            for (i = 0; i < markersCount; i++) {
                                switch(visibleMarkers[i].style.transform.search(/rotate/g)) {
                                case -1:
                                    visibleMarkers[i].style.transform += ' rotateY(' + degY[i] + 'deg) rotateX(' + degX[i] + 'deg)';
                                    break;
                                default:
                                    visibleMarkers[i].style.transform.replace(/rotateY\(([\d.]+)deg\) rotateX\(([\d.]+)deg\)/g, degY[i] + ', ' + degX[i]);
                                    break;
                                }
                            }  
                        }
                        
                        for (i = 0; i < markersCount; i++) {
                            switch(visibleMarkers[i].style.transform.search(/scale/g)) {
                                case -1:
                                    visibleMarkers[i].style.transform += 'scale(' + scale + ')';
                                    break;
                                default:
                                    visibleMarkers[i].style.transform.replace(/scale\(([\d.]+)\)/g, scale);
                                    break;
                            }
                        }
                    });
                }
            });
        </script>
    </body>
</html>